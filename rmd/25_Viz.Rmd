---
title: "Data Visualization"
date: "`r format(Sys.time(), '%d %B, %Y')`"

output:
  bookdown::html_document2:
    number_sections: false
    theme: spacelab
    highlight: monochrome
    code_folding: show
    toc: true
    toc_float: true
    toc_depth: 2
    df_print: paged

params:
  Nthreads:
    label: 'Number of Threads:'
    value: 8
    input: slider
    min: 4
    max: 96
  Nmemgb:
    label: 'Gigabytes of Memory per Thread:'
    value: 8
    input: slider
    min: 4
    max: 16
  fork:
    label: 'Fork processes (not GUI)'
    value: FALSE
    input: checkbox
  seed:
    label: 'Random seed:'
    value: 8211673
  dimensionality:
    label: 'Dimensionality of single-cell dataset:'
    value: 10
  cluster_resolution:
    label: 'Parameter for clustering algorithm:'
    value: 0.5
---

<!-- 
https://satijalab.org/seurat/articles/visualization_vignette.html#interactive-plotting-features

https://samuel-marsh.github.io/scCustomize/articles/Gene_Expression_Plotting.html#shuffle-points

https://samuel-marsh.github.io/scCustomize/reference/index.html
-->

# Setup

```{r}
timestamp()
```

```{r}
getwd()
```


```{r}
cbind(params)
```

```{r}
library(tidyverse)
library(patchwork)
library(scCustomize)
library(Seurat)
```

```{r}
set.seed(params$seed)
knitr::opts_chunk$set(echo = TRUE, format = TRUE, out.width = "100%")

options(
  parallelly.fork.enable = params$fork,
  future.globals.maxSize = params$Nmemgb * 1024^2 * 1000
)

plan("multicore", workers = params$Nthreads)

myFlappy <- function(x, ...) {
  future.apply::future_lapply(x, ..., future.seed = TRUE)
}
```

## Load Data

We'll be working with the data from Day 1, `14_FirstSteps.Rmd`, let's quickly re-load and re-process again:

```{r}
pbmc <- Read10X(data.dir = "./datasets/filtered_gene_bc_matrices/hg19/") %>%
  CreateSeuratObject(counts = ., project = "pbmc3k", min.cells = 3, min.features = 200)

pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")
pbmc <- subset(pbmc, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
pbmc <- NormalizeData(pbmc, verbose = FALSE)
pbmc <- FindVariableFeatures(pbmc, verbose = FALSE)
pbmc <- ScaleData(pbmc, features = rownames(pbmc), verbose = FALSE)
pbmc <- RunPCA(pbmc, features = VariableFeatures(pbmc), verbose = FALSE)
pbmc <- FindNeighbors(pbmc, dims = seq_len(params$dimensionality), verbose = FALSE)
pbmc <- FindClusters(pbmc, resolution = params$cluster_resolution, verbose = FALSE)
pbmc <- RunUMAP(pbmc, dims = seq_len(params$dimensionality), verbose = FALSE)

new.cluster.ids <- c("Naive CD4 T", "CD14+ Mono", "Memory CD4 T", "B", "CD8 T", "FCGR3A+ Mono", "NK", "DC", "Platelet")
names(new.cluster.ids) <- levels(pbmc)
pbmc <- RenameIdents(pbmc, new.cluster.ids)
rm(new.cluster.ids)
```

# Marker Expression

Visualize single cell expression distributions in each cluster. We'll pick some genes for this:

```{r}
features <- c("LYZ", "CCL5", "IL32", "PTPRCAP", "FCGR3A", "PF4")
```

## Ridge plots

```{r, fig.asp=1.3}
# fig.asp? sets the height-to-width ratio of the figure. Use in combination with either fig.width and fig.height if needed.
# https://bookdown.org/yihui/rmarkdown-cookbook/figure-size.html
# value < 1 makes the plot wider
# value > 1 makes the plot taller
RidgePlot(pbmc, features = features, ncol = 2)
```

## Violin plot

```{r, fig.asp=1.5}
VlnPlot(pbmc, features = features)
```

## Feature plot

```{r, fig.asp=1.3}
FeaturePlot(pbmc, features = features)
```

## Dot plots

The size of the dot corresponds to the percentage of cells expressing the feature in each cluster. The color represents the average expression level.

```{r, fig.asp=0.9}
DotPlot(pbmc, features = features) + RotatedAxis()
```

## Heatmap of feature expression

```{r}
DoHeatmap(subset(pbmc, downsample = 100), features = features, size = 3)
```
