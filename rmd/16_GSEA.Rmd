---
title: "Functional Analyses"
date: "`r format(Sys.time(), '%d %B, %Y')`"

output:
  bookdown::html_document2:
    number_sections: false
    global_numbering: true
    theme: spacelab
    highlight: pygments
    code_folding: show
    toc: true
    toc_float: true
    toc_depth: 2
    df_print: paged
---

# Setup
```{r setup, echo=FALSE}
# uncomment and thank your tutor if libraries are provided
#.libPaths(new = "/scratch/local/rseurat/pkg-lib-4.1.3")

suppressMessages(library(tidyverse))
suppressMessages(library(enrichR))
suppressMessages(library(Seurat))
#library(future) # no future here?

set.seed(8211673)
knitr::opts_chunk$set(echo = TRUE, format = TRUE, out.width = "100%")

cat("library path: ", .libPaths())
cat("work directory: ", getwd())
```

# Basic Processing (repetition)

We'll be working with the data from our past notebook ("First steps"), let's quickly re-load and re-process again:

```{r first_steps, warning=FALSE}
# NOTE: This code block will be repeated throughout the course, and it has 5 parameters that are good candidates to be moved to the YAML header(s). If this were an actual research report, we would have probably done this.

pbmc <- Read10X(data.dir = "./datasets/filtered_gene_bc_matrices/hg19/") %>%
  CreateSeuratObject(counts = ., project = "pbmc3k", min.cells = 3, min.features = 200)

pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")

pbmc <- subset(pbmc, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)

pbmc <- NormalizeData(pbmc, verbose = FALSE)

pbmc <- FindVariableFeatures(pbmc, verbose = FALSE)

pbmc <- ScaleData(pbmc, features = rownames(pbmc), verbose = FALSE)

pbmc <- RunPCA(pbmc, features = VariableFeatures(pbmc), verbose = FALSE)
```

# Getting Gene Sets
[This section is new and utilizes fragments that came later. But logically we first have to define gene lists - and then GSEA GO etc]

[TM: should also rethink the ranking here, and move the whole rmd after DE analysis and with log-fold changes, rather than PC loadings. It feels more natural to have the GO/GSEA after DE.
In this case the block above should contain also ... FindCluster, FindMarkers ... and should probably _not_ be run anymore.
]


Recall: In our analysis, each cell lives in a high-dimensional space (#genes) and PCA analysis rotates the data using
more convenient axes (principal components=PC).

As a first step, we can also rank the genes by their contribution to a specific PC.
This is also called the `loadings` and they can be obtained easily like so:

```{r loadings}
loads <- Loadings(pbmc[["pca"]])
loads[,1:5] %>% head()
```


**Task**: Sort all genes according to their contribution to PC_1 and extract the top 5 gene names.
Next try to extract the bottom 5 genes.

**Poll**: What are those genes?
```{r geneset1, echo=FALSE}
gene.set.1 <- loads %>% as.data.frame() %>% 
  arrange(-PC_1) %>% 
  head(50) %>% 
  rownames()
#gene.set.1
```

[TM: I replaced the original task (to edit a function) with the above task. It seems the function was erroneous: no data.frame conversion, missing comma. It was also never used again ]


# Functional Enrichment Analysis

These methods have first been used for microarrays, and aim to draw conclusions ranked gene list from RNAseq experiments, scRNA, or any other OMICS screen. There are a number of tools and approaches - here we will focus only one common and practical approach.

For more information: see [clusterProfiles](https://yulab-smu.top/biomedical-knowledge-mining-book/clusterProfiler-dplyr.html).

The aim is to draw conclusions as to what's the functional implications that we may be able to derive given a list of genes. To this end, we'd start with such list and then consult databases for the annotations. With this data, we can come up with scores to measure level of association. A gene set is an unordered collection of genes that are functionally related.

[TM: I removed a paragraph about GSEA to stay on focus. AFAIK enrichr does not support GSEA]

## Gene Ontology

[GO Terms](http://www.geneontology.org/) are semantic representations in a curated database that defines concepts/classes used to describe gene function, and relationships between these concepts. GO terms are organized in a directed acyclic graph, where edges between terms represent parent-child relationship. It classifies functions along three aspects:

- MF: Molecular Function, molecular activities of gene products
- CC: Cellular Compartment, where gene products are active
- BP: Biological Processes, pathways and larger processes made up of the activities of multiple gene products

## enrichR

The package is already loaded. But we need to connect to the databases that we'll be using. There are more than 200 databases available, you can get a data frame with details of these using `listEnrichrDbs()`.

```{r dbs}
dbs <- c(
  "GO_Biological_Process_2021",
  "GO_Cellular_Component_2021",
  "GO_Molecular_Function_2021"
)
```


```{r enrichr}
result.1 <- enrichr(gene.set.1, dbs)
#result.1$GO_Molecular_Function_2021
```

**Task**: Understand the format and interpretation of the output `result.1`

**Poll**: What is the most significantly enriched molecular function and based on which genes
[ pos. loadings: ferric iron binding FTL]
[ neg. loadings: cytokine receptor activity, IL7R]

**Poll**: would you get the same result if you changed the number of genes in gene.set.1? Try it out.


We can also produce nice graphical summaries:
```{r plotenrichr}
plotEnrich(result.1[[1]], showTerms = 20, numChar = 40, y = "Count", orderBy = "P.value")
```


[TM: I removed the various functions to prettify the plot. Neat solutions, but they are too far off topic and not used again. 
As a result also DT became dispensible, I believe]

Notice that - using dplyr powers - you can also customize your selection and subsetting of top ranking categories
```{r plotenrich_finetuning}
result.1$GO_Cellular_Component_2021 %>% 
  filter(Adjusted.P.value < 5e-2) %>%
  arrange(-Combined.Score) %>% 
  plotEnrich(showTerms=20, numChar=40, y="Count")
```

**Task**: Expore the above code block and make your own choices of GO categories and filters.


# End

