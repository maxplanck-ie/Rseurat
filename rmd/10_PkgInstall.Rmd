---
title: "Package Installation"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    number_sections: false
    theme: spacelab
    highlight: monochrome
    code_folding: show
    toc: true
    toc_float: true
    toc_depth: 2
    df_print: paged
---

```{r setup}
knitr::opts_chunk$set(eval=FALSE, format=TRUE)
options(warn=-1)
```

PLEASE READ ALL THE TEXT, the following steps are rather sensitive. So, unfortunately, it's not a matter of going ahead clicking the `Run` button in each code block and just get it done.

Make sure you allow for 30-60 minutes to complete all the steps. The exact time will depend on network performance, and the current state of your package library (e.g., previous packages installed).

Thanks for taking the time to do this before the course!

> **Important**
> - Ensure you're running R `4.1.3`. The following procedure wasn't tested with recent versions.
> - Run each of the code blocks manually, and ensure there were no errors before moving forward.
> - Watch out for possible errors. It woud be wise to keep an eye on the text output at all time.
> - To emphasize the last item, let's rephrase it: shouldn't be a surprise if you have a compilation error message in the middle of the whole text output.
> - If asked to update packages, answer 'none'. We'll take care of package updates near the end.
> - If asked to compile packages, answer 'no'.
> - All code blocks may be executed more than once, if the packages are installed, there's no increase in the total duration of this whole process. So, do run them a couple of times before moving forward to the next block.
> - If you see errors, re-run the code block again.

# Bioconductor

<Bioconductor.org> is a repository of bioinformatic packages, just like CRAN (which also has bioinformatic packages). The difference is that instead of GNU Public License, Bioc packages are under a license that allows commercial usage, widening its user-base (e.g. including private hospitals).

```{r BiocManager}
if (! "BiocManager" %in% installed.packages()) install.packages("BiocManager")
```

With `BiocManager`, we can install Bioconductor `3.14`. If you are using R 4.2 or 4.3, then you'd be looking for a newest release, see the [official release announcements](https://bioconductor.org/about/release-announcements/) to find your matching version. If you really need it, you may use bioconductor `3.16`, but these lectures were only tested with the versions we are recommending (4.1.3 & 3.14).

```{r bioc314}
BiocManager::install(version='3.14')
```

> You can ignore the message:
> 
> ```
> Bioconductor version 3.14 (BiocManager
>   1.30.20), R 4.1.3 (2022-03-10)
> Installation paths not writeable, unable to
>   update packages
>   path: /opt/R/4.1.3/lib/R/library
>   packages:
>     boot, class, cluster, codetools, foreign,
>     MASS, Matrix, mgcv, nlme, nnet, rpart,
>     spatial, survival
> ```

# Core & Dependencies

The next code block defines a function, `retrieve_namespaces()`, that takes a character vector with package names, to be installed. If the execution of the whole function is not interrupted by an error, it will simply return `TRUE`.

```{r retrieve_namespaces}
retrieve_namespaces <- function(list_of_packages=c()) {
  lapply(list_of_packages,
         function(x) {
           if (! x %in% installed.packages()) {
             BiocManager::install(x, ask=FALSE, update=FALSE) } } )
  TRUE
}
```

Let's use it. We are going to install [Seurat](https://satijalab.org/seurat/) as well as many other tools and dependencies that we will need throughout this course. The whole process is going to take 10-15 minutes... and, most probably, more than just one single execution.

```{r}
retrieve_namespaces(
  list_of_packages = c(
    # Utilities
    "sessioninfo",
    "remotes",
    "shiny",
    "knitr",
    "rmarkdown",
    "markdown",
    "bookdown",
    "formatR",
    "DT",
    # Core
    "tidyverse",
    "magrittr",
    "future",
    "future.apply",
    "Seurat",
    # DE
    "enrichR",
    "metap",
    "openxlsx",
    "glmGamPoi",
    "DESeq2",
    "limma",
    "MAST",
    # Viz
    "Nebulosa",
    "patchwork",
    "RColorBrewer",
    "scCustomize",
  )
)
```

Sometimes, there are errors while installing packages in bulk that are easily solved by re-iterating the command. These error messages are difficult to track, since we get so much output from the ongoing process. Installing 10-20 packages may look as a simple activity, but that's not the case when we consider all the dependencies between them.

**Re-run the previous code block 2-3 times until its only output is: `TRUE`.**

On workbench, after a couple of re-runs, we needed to remove locks manually, you may do so from your Terminal:

```{bash, eval=FALSE}
rm -rf /rstudio/${USER}/rstudio/R/workbench-library/4.1/00LOCK-*
rm -rf /rstudio/${USER}/.rstudio/R/workbench-library/4.1/00LOCK-*
```


# Consistency

- Finally, we want our installation to be coherent:

```{r}
BiocManager::valid()
```

If the above code block fails, is because according to BiocManager our current state is not valid (so, it didn't return `TRUE` to `stopifnot`). To correct this, you should run the `BiocManager::install()` command as it's stated by `BiocManager::valid()`.

# Datasets

R packages bundle data with them, usually for testing purposes. In the case of `Seurat`, there is a package (`SeuratData`) specifically designed to download some datasets. You may use `SeuratData::AvailableData()` to get a table of all these 'educational' datasets. Let's get a dataset:

```{r}
if (! "SeuratData" %in% installed.packages()) remotes::install_github('satijalab/seurat-data')
if (! "ifnb.SeuratData" %in% installed.packages()) SeuratData::InstallData("ifnb")
if (! "pbmc3k.SeuratData" %in% installed.packages()) SeuratData::InstallData("pbmc3k")
```

We are going to use another package that is only available on GitHub and not on Bioconductor or CRAN repos:

```{r}
if (! "kBET" %in% installed.packages()) remotes::install_github('theislab/kBET')
```


## Download preprocessed datasets from zenodo

For the later part of the course, we have preprocessed a couple of large datasets. Depending on where you will be working, there are two alternative ways now...

1: For those that will be using Workbench/ RStudio Server, the datasets will be already provided under `/scratch/local/rseurat/datasets`. You can copy from this location, and skip the download.

```{bash, eval=FALSE}
cp -r /scratch/local/rseurat/datasets/preprocessed_rds ${PWD}/datasets/preprocessed_rds
```


2: If you will be using RStudio from your laptop, then you may download from zenodo:

1. ["datasets/preprocessed_rds/panc_sub.RDS"](https://zenodo.org/record/7848230/files/panc_sub.RDS?download=1)
1. ["datasets/preprocessed_rds/ref.labels.RDS"](https://zenodo.org/record/7845337/files/ref.labels.RDS?download=1)
1. ["datasets/preprocessed_rds/pbmc_ref.seurat.RDS"](https://zenodo.org/record/7845337/files/pbmc_ref.seurat.RDS?download=1)

Depending on your bandwidth, the downloads may take 15-30 minutes.

# Working Directory

Download all the course RMarkdown documents in a zip file from [the repository at GitHub](https://github.com/maxplanck-ie/Rseurat/archive/refs/heads/main.zip). Put it in a folder, any folder but outside the `/home` partition! You will find all the lectures under `rmd/` subfolder. On the root you'll find an `Rproj` file, so you should **open the corresponding path as an existing project folder** in RStudio IDE.