---
title: "Package Installation"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    theme: spacelab
    highlight: monochrome
    code_folding: show
    toc: true
    toc_float: true
    toc_depth: 2
    df_print: paged
---

```{r setup}
knitr::opts_chunk$set(eval=FALSE, format=TRUE)
```

PLEASE READ ALL THE TEXT, the following steps are rather sensitive. So, unfortunately, it's not a matter of going ahead clicking the `Run` button in each code block and just get done with it.

Make sure you allow for 30-60 minutes to complete all the steps. The exact time will depend on network performance, and the current state of your package library (e.g., previous packages installed).

Thanks for taking the time to do this before the course!

> **Important**
> - Ensure you're running R `4.1.3`.
> - Run the blocks manually.
> - If asked to compile packages, answer 'no'.
> - Watch out for possible errors. It woud be wise to keep an eye on the text output at all time.
> - To emphasize the last item, let's rephrase it: shouldn't be a surprise if you have a compilation error message in the middle of the whole text output.
> - If asked to update packages, answer 'none'. We'll take care of package updates near the end.
> - All code blocks may be executed more than once, if the packages are installed, there's no increase in the total duration of this whole process. So, do run them a couple of times before moving forward to the next block.
> - If you see errors, re-run the code block again.

# Main Packages

```{r mainpkgs}
installed_pkgs <- installed.packages()

if (! "tidyverse" %in% installed_pkgs) install.packages("tidyverse")

if (! "markdown" %in% installed_pkgs) install.packages("markdown") 

if (! "remotes" %in% installed_pkgs) install.packages("remotes") 

if (! "BiocManager" %in% installed_pkgs) install.packages("BiocManager")
```

# Bioconductor

With `BiocManager`, we can install Bioconductor `3.14`. If you are using R 4.2 or 4.3, then you'd be looking for a newest release, see the [official release announcements](https://bioconductor.org/about/release-announcements/) to find your matching version. If you really need it, you may use bioconductor `3.16`, but these lectures were only tested with the versions we are recommending (4.1.3 & 3.14).

```{r bioc314}
BiocManager::install(version='3.14')
```

> You can ignore the message:
> 
> ```
> Bioconductor version 3.14 (BiocManager
>   1.30.20), R 4.1.3 (2022-03-10)
> Installation paths not writeable, unable to
>   update packages
>   path: /opt/R/4.1.3/lib/R/library
>   packages:
>     boot, class, cluster, codetools, foreign,
>     MASS, Matrix, mgcv, nlme, nnet, rpart,
>     spatial, survival
> ```

# Core & Dependencies

The next code block defines a function, `my_load_namespaces()`, that takes two named arguments: `packagesToLoad` and `coreLibraries`. Both are vectors of strings, corresponding to packages that need to be installed. Then, the function loads each of the packages specified in `packagesToLoad` vector, through the use of the `require` base R function. The `coreLibraries` are not explicitly loaded, but required anyway (e.g. dependencies). If the execution of the whole function is alright, it will simply return `TRUE`.

```{r my_load_namespaces}
my_load_namespaces <- function(packagesToLoad=c(), coreLibraries=c(), installed_pkgs=installed_pkgs) {
  
  if (! "BiocManager" %in% installed_pkgs) install.packages("BiocManager")
  
  lapply(c(coreLibraries, packagesToLoad),
         function(x) if (! x %in% installed_pkgs) BiocManager::install(x, ask = FALSE))
  
  lapply(packagesToLoad, function(pkg) {
    suppressPackageStartupMessages(require(pkg, character.only = TRUE))
  })
  
  TRUE
}
```

Let's use it. We are going to install [Seurat](https://satijalab.org/seurat/) as well as many other tools and dependencies that we will need throughout this course. The whole process is going to take 10-15 minutes... and, most probably, more than just one single execution.

```{r}
my_load_namespaces(
  packagesToLoad = c("openxlsx", "readr", "magrittr", "dplyr", "RColorBrewer", "ggplot2", "patchwork", "Seurat", "future", "glmGamPoi"),
  coreLibraries = c("knitr", "RCurl", "rmarkdown", "formatR", "DT", "reticulate", "sessioninfo", "limma", "DESeq2", "uwot", "future.apply", "metap", "enrichR", "shiny", "SingleCellExperiment", "Nebulosa", "bookdown"),
  installed_pkgs = installed_pkgs
)
```

Sometimes, there are errors while installing packages in bulk that are easily solved by re-iterating the command. These error messages are difficult to track, since we get so much output from the ongoing process in bulk, and also because of all the dependencies. This is specially true for first-comers, because their library of packages is empty. Anyhow, just re-run the previous code block 2-3 times until its only output is: `TRUE`. It shouldn't come as a surprise if after many re-runs you needed to remove locks manually.

# Consistency

- Finally, we want our installation to be coherent:

```{r}
if (interactive()) stopifnot(
  suppressMessages(
    BiocManager::valid()
    )
  )
```

If the above code block fails, is because according to BiocManager our current state is not valid (so, it didn't return `TRUE` to `stopifnot`). To correct this, you should run the `BiocManager::install()` command as it's stated by `BiocManager::valid()`.

# Datasets

R packages bundle data with them, usually for testing purposes. In the case of `Seurat`, there is a package (`SeuratData`) specifically designed to download some datasets. You may use `SeuratData::AvailableData()` to get a table of all these 'educational' datasets. Let's get a dataset:

```{r}
if (! "SeuratData" %in% installed_pkgs) remotes::install_github('satijalab/seurat-data')
if (! "ifnb.SeuratData" %in% installed_pkgs) SeuratData::InstallData("ifnb")
if (! "pbmc3k.SeuratData" %in% installed_pkgs) SeuratData::InstallData("pbmc3k")
```

We are going to use another package that is only available on GitHub and not on Bioconductor or CRAN repos:

```{r}
if (! "kBET" %in% installed_pkgs) remotes::install_github('theislab/kBET')
```


## Download preprocessed datasets from zenodo

For the later part of the course, we have preprocessed a couple of large datasets. Depending on where you will be working, there are two alternative ways now...

1: For those that will be using Workbench/ RStudio Server, the datasets will be already provided under `/scratch/local/rseurat/datasets`. You can have a symbolic link to this location, and skip the download.

2: If you will be using RStudio from your laptop, then you may download from zenodo:

1. ["datasets/preprocessed_rds/panc_sub.RDS"](https://zenodo.org/record/7848230/files/panc_sub.RDS?download=1)
1. ["datasets/preprocessed_rds/ref.labels.RDS"](https://zenodo.org/record/7845337/files/ref.labels.RDS?download=1)
1. ["datasets/preprocessed_rds/pbmc_ref.seurat.RDS"](https://zenodo.org/record/7845337/files/pbmc_ref.seurat.RDS?download=1)

Depending on your bandwidth, the downloads may take 15-30 minutes.

# Working Directory

Download all the course RMarkdown documents in a zip file from [the repository at GitHub](https://github.com/maxplanck-ie/Rseurat/archive/refs/heads/main.zip). Put it in a folder, any folder but outside the `/home` partition!